# Tushare 股票财务指标同步 (Pre-Design)

本文档是基于 Brainstorming 阶段沟通得出的初步架构设计约定。它将作为后续生成标准 OpenSpec 制品 (`design.md`, `specs/`) 的核心输入。

## 1. 核心业务流程与功能范围

系统需要支持从 Tushare 获取 `fina_indicator` (财务指标) 数据。具体使用场景分离为“单次全网历史同步”与“日常增量同步”。

*   **全量历史同步 (Full Sync)**：遍历系统内所有已知股票（`ts_code`），从 Tushare 获取每只股票的全部历史财务指标数据。
*   **按日增量同步 (Incremental Sync)**：根据某个财报或指标的“公告日期” (`ann_date`) 或者指定的 `ts_code` ，局部更新财务指标数据，适用于系统的 Daily Job 触发最新数据拉取。

## 2. 关键设计决策 (Design Decisions)

在方案碰撞后，确认采用以下较为轻量直接的工程策略：

### 2.1 状态管理 (断点续传机制)
为了防止在长达 30 分钟（因频控原因）的全量同步中程序异常中断，我们需要一个状态缓存记录正在/已经处理完毕的股票：
*   **选型结论**：**纯内存结构 (In-Memory Cache)**。
*   **原因与约束**：为了保持架构极简，不引入 Redis，也不在数据库中建立专用的持久化同步任务状态表。
*   **行为预期**：应用拉起全量同步任务后，在应用生命周期内存活期间依靠内部字典或列表防重。如果整个 Python 进程挂掉或重启，下一次触发全量同步时将从零开始重新遍历。

### 2.2 数据冲突处理
由于财报数据存在“事后修正”的场景，不同时间拉取到的相同期数据可能会发生数值变动。
*   **选型结论**：**直接覆盖 (Upsert)**。
*   **行为预期**：数据库操作采用 Upsert 模式（例如基于 `ts_code` + `end_date` / `ann_date` 的联合唯一主键或唯一索引）。遇到记录冲突，旧数据直接被 Tushare 接口返回的最新数据无条件覆盖覆盖，代码层面不做复杂的版本保留策略。

### 2.3 API 与交互接口
关于任务的管理和监控：
*   **选型结论**：**最小化同步接口集**。
*   **行为预期**：只提供专门用于触发“全量同步”和“增量同步”的接口（例如 REST API endpoint 或内部 Command），不提供“查询任务进度”或“停止任务”的端点。系统触发任务后将依靠应用内部日志输出进度。

## 3. 技术落点 (Technical Components)

这些决策将影响到下述具体模块的设计：
1.  **Repository (数据库访问)**: 实现针对 `FinancialIndicator` 实体的批量 Upsert 方法。
2.  **Gateway (外部网关)**: 扩展现有 Tushare 网关逻辑或新建，加入 `fina_indicator` 数据格式合并和请求逻辑，复用当前系统内的速率限制 (`TokenBucket`)。
3.  **Use Cases (应用层命令)**:
    *   `SyncFullFinancialIndicatorCommand`: 触发全市场遍历，内部维护一个 `set()` 记录已抓取的股票，防止同一运行时的并发重复调用。
    *   `SyncIncrementalFinancialIndicatorCommand`: 接受 `ann_date`，拉取对应更新并入库。

---
*注：本文件属于过渡态设计思维草稿。经过确认后，请以此文口吻编写 `design.md`。*
