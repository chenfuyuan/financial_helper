# 安全设计

**日期：** 2026-02-19
**作者：** financial_helper 团队

---

## 11. 安全设计

### 11.1 认证与授权

| 层级 | 方案 |
|------|------|
| API 认证 | JWT (Access Token + Refresh Token) |
| 管理后台 | OAuth2 / SSO |
| 内部服务 | API Key + 签名验证 |

### 11.2 数据安全

- **敏感数据加密**：
  - API Key、数据库密码等使用环境变量 + vault 管理
  - 传输中数据：HTTPS/TLS 1.3
  - 静态数据：数据库加密（可选）
- **数据脱敏**：
  - 日志中自动脱敏敏感信息
  - 响应中按权限脱敏

### 11.3 API 安全

- **限流**：
  - 基于 Redis 的滑动窗口限流
  - 按用户/IP/API Key 分级限流
  - 超限返回 429 Too Many Requests
- **防注入**：
  - SQL：使用 SQLAlchemy 参数化查询
  - NoSQL：使用 ORM/ODM
  - LLM：输入验证 + 输出过滤
- **输入验证**：
  - 使用 Pydantic 模型验证
  - 股票代码格式验证
  - 日期范围验证

### 11.4 LLM 安全

- **Prompt 注入防护**：
  - 输入验证 + 关键词过滤
  - 输出格式强制执行（JSON Schema）
  - 敏感指令检测
- **内容安全**：
  - 生成内容审核
  - 违规内容拦截
- **成本安全**：
  - Token 使用监控
  - 异常使用告警
  - 预算硬限制

### 11.5 审计与日志

- **访问日志**：
  - 所有 API 请求记录
  - 包含用户、时间、IP、参数、响应码
- **操作审计**：
  - 关键操作记录（如配置变更）
  - 支持可追溯性
- **日志安全**：
  - 日志中不包含敏感信息
  - 日志分级（DEBUG/INFO/WARNING/ERROR/CRITICAL）
  - 结构化日志（JSON）

### 11.6 依赖安全

- **依赖扫描**：
  - 使用 `safety` 或 `pip-audit`
  - 定期更新依赖
- **供应链安全**：
  - 使用可信源
  - 验证包完整性
