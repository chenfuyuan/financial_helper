# 错误处理策略

**日期：** 2026-02-19
**作者：** financial_helper 团队

---

## 9. 错误处理策略

### 9.1 错误分层

| 层级 | 错误类型 | 处理方式 |
|------|---------|---------|
| 接口层 | 请求参数错误 | 400 Bad Request + 详细错误信息 |
| 应用层 | 业务规则违反 | 422 Unprocessable Entity + 业务错误码 |
| 领域层 | 领域异常 | 抛出自定义 DomainException |
| 基础设施层 | 外部服务错误 | 重试 + 降级 + 告警 |

### 9.2 关键模块错误处理

#### DATA_ENGINEERING
- **数据源错误**：
  - Tushare/AkShare API 调用失败 → 指数退避重试（最多 3 次）
  - 网络超时 → 切换备用数据源
  - 数据质量异常 → 记录日志 + 告警 + 跳过坏数据
- **ETL 错误**：
  - 数据格式异常 → 灵活解析 + 记录脏数据
  - 数据转换失败 → 回滚事务 + 通知管理员

#### LLM_GATEWAY
- **LLM API 错误**：
  - API 限流 → 排队 + 降级到更便宜的模型
  - 模型响应超时 → 异步处理 + 回调通知
  - Token 超限 → 智能截断 + 分块处理
  - 模型错误 → 自动切换备用模型
- **成本控制**：
  - 单次请求 Token 超限 → 拒绝 + 提示拆分
  - 单日预算超限 → 降级模式 + 通知管理员

#### COORDINATOR
- **流程错误**：
  - 步骤执行失败 → 记录状态 + 支持重试从断点继续
  - 步骤超时 → 取消当前步骤 + 记录失败
  - 流程中断 → 持久化状态 + 支持人工恢复

#### RESEARCH/DEBATE/JUDGE
- **分析错误**：
  - 数据缺失 → 使用默认值 + 标记不确定性
  - LLM 响应异常 → 重试 2 次 → 降级到规则引擎
  - 结果格式异常 → 容错解析 + 记录原始响应

### 9.3 统一错误响应格式

```json
{
  "code": 400,
  "message": "错误描述",
  "error_code": "BUSINESS_RULE_VIOLATION",
  "details": {
    "field": "具体字段",
    "reason": "详细原因"
  }
}
```

### 9.4 告警机制

| 错误级别 | 触发条件 | 通知方式 |
|---------|---------|---------|
| CRITICAL | 系统级故障、数据大规模丢失 | 电话 + 短信 + 邮件 |
| ERROR | 关键流程失败、外部服务不可用 | 企业微信 + 邮件 |
| WARNING | 数据质量异常、性能下降 | 企业微信 |
| INFO | 正常流程记录 | 仅日志 |
